!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).tidePredictor=e()}(this,function(){"use strict";const i=Math.PI/180,n=180/Math.PI;var t=(t,e,a,o,n)=>t+(e=void 0!==e?e:0)/60+(a=void 0!==a?a:0)/3600+(o=void 0!==o?o:0)/36e5+(n=void 0!==n?n:0)/36e8;const u={terrestrialObliquity:[t(23,26,21.448),-t(0,0,4680.93),-t(0,0,1.55),t(0,0,1999.25),-t(0,0,51.38),-t(0,0,249.67),-t(0,0,39.05),t(0,0,7.12),t(0,0,27.87),t(0,0,5.79),t(0,0,2.45)].map((t,e)=>t*Math.pow(.01,e)),solarPerigee:[-77.06265000000002,1.7190199999968172,4591e-7,48e-8],solarLongitude:[280.46645,36000.76983,3032e-7],lunarInclination:[5.145],lunarLongitude:[218.3164591,481267.88134236,-.0013268,1/538841-1/65194e3],lunarNode:[125.044555,-1934.1361849,.0020762,1/467410,-1/60616e3],lunarPerigee:[83.353243,4069.0137111,-.0103238,-1/80053,1/18999e3]},s=t=>(h(t)-2451545)/36525,h=t=>{let e=t.getFullYear(),a=t.getMonth()+1;var t=t.getDate()+t.getHours()/24+t.getMinutes()/1440+t.getSeconds()/86400+t.getMilliseconds()/864e8,o=(a<=2&&(e-=1,a+=12),Math.floor(e/100)),o=2-o+Math.floor(o/4);return Math.floor(365.25*(e+4716))+Math.floor(30.6001*(a+1))+t+o-1524.5},M=(t,e,a)=>{t=i*t,e=i*e,a=i*a;e=Math.cos(e)*Math.cos(a)-Math.sin(e)*Math.sin(a)*Math.cos(t);return n*Math.acos(e)},c=(t,e,a)=>{t=i*t,e=i*e,a=i*a;var o=Math.cos(.5*(a-e))/Math.cos(.5*(a+e))*Math.tan(.5*t),a=Math.sin(.5*(a-e))/Math.sin(.5*(a+e))*Math.tan(.5*t),o=Math.atan(o),a=Math.atan(a);return-((o-=.5*t)+(a-=.5*t))*n},f=(t,e,a)=>{t=i*t,e=i*e,a=i*a;var o=Math.cos(.5*(a-e))/Math.cos(.5*(a+e))*Math.tan(.5*t),a=Math.sin(.5*(a-e))/Math.sin(.5*(a+e))*Math.tan(.5*t),o=Math.atan(o),a=Math.atan(a);return((o-=.5*t)-(a-=.5*t))*n},l=(t,e,a)=>{var o=i*M(t,e,a),t=i*f(t,e,a);return n*Math.atan(Math.sin(2*o)*Math.sin(t)/(Math.sin(2*o)*Math.cos(t)+.3347))},v=(t,e,a)=>{var o=i*M(t,e,a),t=i*f(t,e,a),e=Math.sin(o)**2*Math.sin(2*t)/(Math.sin(o)**2*Math.cos(2*t)+.0727);return.5*n*Math.atan(e)},p=(t,e)=>(t%e+e)%e,m=e=>{const a={},o={s:u.lunarLongitude,h:u.solarLongitude,p:u.lunarPerigee,N:u.lunarNode,pp:u.solarPerigee,90:[90],omega:u.terrestrialObliquity,i:u.lunarInclination},n=(Object.keys(o).forEach(t=>{a[t]={value:p(((t,a)=>{const o=[];return t.forEach((t,e)=>{o.push(t*Math.pow(a,e))}),o.reduce((t,e)=>t+e)})(o[t],s(e)),360),speed:((t,a)=>{const o=[];return t.forEach((t,e)=>{o.push(t*e*Math.pow(a,e-1))}),o.reduce((t,e)=>t+e)})(o[t],s(e))*(1/876600)}}),{I:M,xi:c,nu:f,nup:l,nupp:v}),t=(Object.keys(n).forEach(t=>{const e=n[t];a[t]={value:p(e(a.N.value,a.i.value,a.omega.value),360),speed:null}}),360*(h(e)-Math.floor(h(e)))),r=15;return a["T+h-s"]={value:t+a.h.value-a.s.value,speed:r+a.h.speed-a.s.speed},a.P={value:a.p.value-a.xi.value%360,speed:null},a},d=(t,e)=>(t%e+e)%e,w=(t,e)=>(void 0!==e&&e&&(t.high&&e.height_offset&&e.height_offset.high&&(t.level*=e.height_offset.high),t.low&&e.height_offset&&e.height_offset.low&&(t.level*=e.height_offset.low),t.high&&e.time_offset&&e.time_offset.high&&(t.time=new Date(t.time.getTime()+60*e.time_offset.high*1e3)),t.low&&e.time_offset&&e.time_offset.low&&(t.time=new Date(t.time.getTime()+60*e.time_offset.low*1e3))),t),g=(t,e)=>{if(void 0!==e&&void 0!==e[t])return e[t];return{high:"High",low:"Low"}[t]},S=({timeline:l,constituents:f,start:t})=>{const v=(u,i,s,h,M)=>{const c=[];let e=0;return f.forEach(t=>{var e=t.amplitude,a=t._phase,o=h[t.name],n=i[t.name],r=s[t.name],t=M[t.name];c.push(e*o*Math.cos(n*u+(t+r)-a))}),c.forEach(t=>{e+=t}),e},e={getExtremesPrediction:t=>{const{labels:o,offsets:n}=void 0!==t?t:{},r=[],{baseSpeed:u,u:i,f:s,baseValue:h}=a();let M=!1,c=!1,f=v(0,u,i[0],s[0],h);return l.items.forEach((t,e)=>{var a=l.hours[e],a=v(a,u,i[e],s[e],h);a>f&&c&&r.push(w({time:l.items[e-1],level:f,high:!1,low:!0,label:g("low",o)},n)),a<f&&M&&r.push(w({time:l.items[e-1],level:f,high:!0,low:!1,label:g("high",o)},n)),a>f&&(M=!0,c=!1),a<f&&(M=!1,c=!0),f=a}),r},getTimelinePrediction:()=>{const o=[],{baseSpeed:n,u:r,f:u,baseValue:i}=a();return l.items.forEach((t,e)=>{var a=l.hours[e],t={time:t,hour:a,level:v(a,n,r[e],u[e],i)};o.push(t)}),o}},a=()=>{const o=m(t),n={},r={},e=[],u=[];return f.forEach(t=>{var e=t._model.value(o),a=t._model.speed(o);n[t.name]=i*e,r[t.name]=i*a}),l.items.forEach(t=>{const a={},o={},n=m(t);f.forEach(t=>{var e=d(t._model.u(n),360);a[t.name]=i*e,o[t.name]=d(t._model.f(n),360)}),e.push(a),u.push(o)}),{baseValue:n,baseSpeed:r,u:e,f:u}};return Object.freeze(e)},r={fUnity(){return 1},fMm(t){var e=i*t.omega.value,a=i*t.i.value,t=i*t.I.value,e=(2/3-Math.pow(Math.sin(e),2))*(1-1.5*Math.pow(Math.sin(a),2));return(2/3-Math.pow(Math.sin(t),2))/e},fMf(t){var e=i*t.omega.value,a=i*t.i.value,t=i*t.I.value,e=Math.pow(Math.sin(e),2)*Math.pow(Math.cos(.5*a),4);return Math.pow(Math.sin(t),2)/e},fO1(t){var e=i*t.omega.value,a=i*t.i.value,t=i*t.I.value,e=Math.sin(e)*Math.pow(Math.cos(.5*e),2)*Math.pow(Math.cos(.5*a),4);return Math.sin(t)*Math.pow(Math.cos(.5*t),2)/e},fJ1(t){var e=i*t.omega.value,a=i*t.i.value,t=i*t.I.value,e=Math.sin(2*e)*(1-1.5*Math.pow(Math.sin(a),2));return Math.sin(2*t)/e},fOO1(t){var e=i*t.omega.value,a=i*t.i.value,t=i*t.I.value,e=Math.sin(e)*Math.pow(Math.sin(.5*e),2)*Math.pow(Math.cos(.5*a),4);return Math.sin(t)*Math.pow(Math.sin(.5*t),2)/e},fM2(t){var e=i*t.omega.value,a=i*t.i.value,t=i*t.I.value,e=Math.pow(Math.cos(.5*e),4)*Math.pow(Math.cos(.5*a),4);return Math.pow(Math.cos(.5*t),4)/e},fK1(t){var e=i*t.omega.value,a=i*t.i.value,o=i*t.I.value,t=i*t.nu.value,e=.5023*(Math.sin(2*e)*(1-1.5*Math.pow(Math.sin(a),2)))+.1681;return Math.pow(.2523*Math.pow(Math.sin(2*o),2)+.1689*Math.sin(2*o)*Math.cos(t)+.0283,.5)/e},fL2(t){var e=i*t.P.value,a=i*t.I.value,e=Math.pow(1-12*Math.pow(Math.tan(.5*a),2)*Math.cos(2*e)+36*Math.pow(Math.tan(.5*a),4),.5);return r.fM2(t)*e},fK2(t){var e=i*t.omega.value,a=i*t.i.value,o=i*t.I.value,t=i*t.nu.value,e=.5023*(Math.sin(e)**2*(1-1.5*Math.sin(a)**2))+.0365;return Math.pow(.2523*Math.pow(Math.sin(o),4)+.0367*Math.pow(Math.sin(o),2)*Math.cos(2*t)+.0013,.5)/e},fM1(t){var e=i*t.P.value,a=i*t.I.value,e=Math.pow(.25+1.5*Math.cos(a)*Math.cos(2*e)*Math.pow(Math.cos(.5*a),-.5)+2.25*Math.pow(Math.cos(a),2)*Math.pow(Math.cos(.5*a),-4),.5);return r.fO1(t)*e},fModd(t,e){return Math.pow(r.fM2(t),e/2)},uZero(t){return 0},uMf(t){return-2*t.xi.value},uO1(t){return 2*t.xi.value-t.nu.value},uJ1(t){return-t.nu.value},uOO1(t){return-2*t.xi.value-t.nu.value},uM2(t){return 2*t.xi.value-2*t.nu.value},uK1(t){return-t.nup.value},uL2(t){var e=i*t.I.value,a=i*t.P.value,e=n*Math.atan(Math.sin(2*a)/(1/6*Math.pow(Math.tan(.5*e),-2)-Math.cos(2*a)));return 2*t.xi.value-2*t.nu.value-e},uK2(t){return-2*t.nupp.value},uM1(t){var e=i*t.I.value,a=i*t.P.value,e=n*Math.atan((5*Math.cos(e)-1)/(7*Math.cos(e)+1)*Math.tan(a));return t.xi.value-t.nu.value+e},uModd(t,e){return e/2*r.uM2(t)}},O=(t,a)=>{const o=[];return t.forEach((t,e)=>{o.push(t*a[e])}),o.reduce((t,e)=>t+e)},y=t=>[t["T+h-s"],t.s,t.h,t.p,t.N,t.pp,t[90]];var t=(t,e,a,o)=>{if(!e)throw new Error("Coefficient must be defined for a constituent");t={name:t,coefficients:e,value:t=>O(e,(t=>{const e=[];return y(t).forEach(t=>{e.push(t.value)}),e})(t)),speed(t){return O(e,(t=>{const e=[];return y(t).forEach(t=>{e.push(t.speed)}),e})(t))},u:void 0!==a?a:r.uZero,f:void 0!==o?o:r.fUnity};return Object.freeze(t)},e=(t,e)=>{const o=[];e.forEach(({constituent:t,factor:a})=>{t.coefficients.forEach((t,e)=>{void 0===o[e]&&(o[e]=0),o[e]+=t*a})});t={name:t,coefficients:o,speed:a=>{let o=0;return e.forEach(({constituent:t,factor:e})=>{o+=t.speed(a)*e}),o},value:a=>{let o=0;return e.forEach(({constituent:t,factor:e})=>{o+=t.value(a)*e}),o},u:a=>{let o=0;return e.forEach(({constituent:t,factor:e})=>{o+=t.u(a)*e}),o},f:a=>{const o=[];return e.forEach(({constituent:t,factor:e})=>{o.push(Math.pow(t.f(a),Math.abs(e)))}),o.reduce((t,e)=>t*e)}};return Object.freeze(t)};const E={},b=(E.Z0=t("Z0",[0,0,0,0,0,0,0],r.uZero,r.fUnity),E.SA=t("Sa",[0,0,1,0,0,0,0],r.uZero,r.fUnity),E.SSA=t("Ssa",[0,0,2,0,0,0,0],r.uZero,r.fUnity),E.MM=t("MM",[0,1,0,-1,0,0,0],r.uZero,r.fMm),E.MF=t("MF",[0,2,0,0,0,0,0],r.uMf,r.fMf),E.Q1=t("Q1",[1,-2,0,1,0,0,1],r.uO1,r.fO1),E.O1=t("O1",[1,-1,0,0,0,0,1],r.uO1,r.fO1),E.K1=t("K1",[1,1,0,0,0,0,-1],r.uK1,r.fK1),E.J1=t("J1",[1,2,0,-1,0,0,-1],r.uJ1,r.fJ1),E.M1=t("M1",[1,0,0,0,0,0,1],r.uM1,r.fM1),E.P1=t("P1",[1,1,-2,0,0,0,1],r.uZero,r.fUnity),E.S1=t("S1",[1,1,-1,0,0,0,0],r.uZero,r.fUnity),E.OO1=t("OO1",[1,3,0,0,0,0,-1],r.uOO1,r.fOO1),E["2N2"]=t("2N2",[2,-2,0,2,0,0,0],r.uM2,r.fM2),E.N2=t("N2",[2,-1,0,1,0,0,0],r.uM2,r.fM2),E.NU2=t("NU2",[2,-1,2,-1,0,0,0],r.uM2,r.fM2),E.M2=t("M2",[2,0,0,0,0,0,0],r.uM2,r.fM2),E.LAM2=t("LAM2",[2,1,-2,1,0,0,2],r.uM2,r.fM2),E.L2=t("L2",[2,1,0,-1,0,0,2],r.uL2,r.fL2),E.T2=t("T2",[2,2,-3,0,0,1,0],r.uZero,r.fUnity),E.S2=t("S2",[2,2,-2,0,0,0,0],r.uZero,r.fUnity),E.R2=t("R2",[2,2,-1,0,0,-1,2],r.uZero,r.fUnity),E.K2=t("K2",[2,2,0,0,0,0,0],r.uK2,r.fK2),E.M3=t("M3",[3,0,0,0,0,0,0],t=>r.uModd(t,3),t=>r.fModd(t,3)),E.MSF=e("MSF",[{constituent:E.S2,factor:1},{constituent:E.M2,factor:-1}]),E["2Q1"]=e("2Q1",[{constituent:E.N2,factor:1},{constituent:E.J1,factor:-1}]),E.RHO=e("RHO",[{constituent:E.NU2,factor:1},{constituent:E.K1,factor:-1}]),E.MU2=e("MU2",[{constituent:E.M2,factor:2},{constituent:E.S2,factor:-1}]),E["2SM2"]=e("2SM2",[{constituent:E.S2,factor:2},{constituent:E.M2,factor:-1}]),E["2MK3"]=e("2MK3",[{constituent:E.M2,factor:1},{constituent:E.O1,factor:1}]),E.MK3=e("MK3",[{constituent:E.M2,factor:1},{constituent:E.K1,factor:1}]),E.MN4=e("MN4",[{constituent:E.M2,factor:1},{constituent:E.N2,factor:1}]),E.M4=e("M4",[{constituent:E.M2,factor:2}]),E.MS4=e("MS4",[{constituent:E.M2,factor:1},{constituent:E.S2,factor:1}]),E.S4=e("S4",[{constituent:E.S2,factor:2}]),E.M6=e("M6",[{constituent:E.M2,factor:3}]),E.S6=e("S6",[{constituent:E.S2,factor:3}]),E.M8=e("M8",[{constituent:E.M2,factor:4}]),t=>{if(t instanceof Date)return t;if("number"==typeof t)return new Date(1e3*t);throw new Error("Invalid date format, should be a Date object, or timestamp")}),T=(t,e,a)=>{a=void 0!==a?a:600;const o=[];var n=e.getTime()/1e3;let r=t.getTime()/1e3;var u=r;const i=[];for(;r<=n;)o.push(new Date(1e3*r)),i.push((r-u)/3600),r+=a;return{items:o,hours:i}},_=({harmonicConstituents:t,phaseKey:a,offset:e})=>{if(!Array.isArray(t))throw new Error("Harmonic constituents are not an array");const o=[];t.forEach((t,e)=>{if(void 0===t.name)throw new Error("Harmonic constituents must have a name property");void 0!==E[t.name]&&(t._model=E[t.name],t._phase=i*t[a],o.push(t))}),!1!==e&&o.push({name:"Z0",_model:E.Z0,_phase:0,amplitude:e});let n=new Date,r=new Date;const u={setTimeSpan:(t,e)=>{if(n=b(t),r=b(e),n.getTime()>=r.getTime())throw new Error("Start time must be before end time");return u},prediction:t=>(t=void 0!==t?t:{timeFidelity:600},S({timeline:T(n,r,t.timeFidelity),constituents:o,start:n}))};return Object.freeze(u)};return(t,e)=>{const r={harmonicConstituents:t,phaseKey:"phase_GMT",offset:!1};return void 0!==e&&Object.keys(r).forEach(t=>{void 0!==e[t]&&(r[t]=e[t])}),{getTimelinePrediction:({start:t,end:e})=>_(r).setTimeSpan(t,e).prediction().getTimelinePrediction(),getExtremesPrediction:({start:t,end:e,labels:a,offsets:o,timeFidelity:n})=>_(r).setTimeSpan(t,e).prediction({timeFidelity:n}).getExtremesPrediction(a,o),getWaterLevelAtTime:({time:t})=>{var e=new Date(t.getTime()+6e5);return _(r).setTimeSpan(t,e).prediction().getTimelinePrediction()[0]}}}});